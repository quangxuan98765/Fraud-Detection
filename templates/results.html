{% extends 'layout.html' %}

{% block title %}Kết Quả Phân Tích Gian Lận{% endblock %}

{% block extra_css %}
<style>
.node-chart {
    height: 500px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #f8f9fa;
}
.metric-card {
    transition: transform 0.3s ease;
}
.metric-card:hover {
    transform: translateY(-5px);
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-12">
        <h1 class="display-5 mb-3">Kết Quả Phân Tích Gian Lận</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
                <li class="breadcrumb-item active" aria-current="page">Kết quả</li>
            </ol>
        </nav>
    </div>
</div>

<!-- Dashboard chính -->
<div class="row mb-4">
    <!-- Metric Cards -->
    <div class="col-md-3">
        <div class="card metric-card border-primary text-center mb-3">
            <div class="card-body">
                <h5 class="card-title text-primary">Tài khoản</h5>
                <p class="display-5 mb-0" id="totalAccounts">...</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card border-success text-center mb-3">
            <div class="card-body">
                <h5 class="card-title text-success">Giao dịch</h5>
                <p class="display-5 mb-0" id="totalTransactions">...</p>
            </div>
        </div>    </div>    <div class="col-md-3">        <div class="card metric-card border-danger text-center mb-3">            <div class="card-body">
                <h5 class="card-title text-danger">Giao dịch bị phát hiện</h5>
                <p class="display-5 mb-0" id="fraudCount">...</p>
                <small class="text-muted">(fraud_score > {{ fraud_threshold }})</small>
                <br>
                <small class="text-muted">Đã giảm ngưỡng để tăng khả năng phát hiện</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card border-warning text-center mb-3">
            <div class="card-body">
                <h5 class="card-title text-warning">Cộng đồng</h5>
                <p class="display-5 mb-0" id="communityCount">...</p>
            </div>
        </div>
    </div>
</div>

<!-- Biểu đồ và Bảng -->
<div class="row mb-4">
    <!-- Network Graph -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-network-wired me-2"></i> Biểu Đồ Mạng Lưới Gian Lận</span>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-light" id="zoomIn">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button class="btn btn-sm btn-light" id="zoomOut">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button class="btn btn-sm btn-light" id="resetZoom">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="network-graph" class="node-chart">
                    <!-- D3.js graph will be rendered here -->
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="lead">Đang tải biểu đồ...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Suspicious Accounts -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <i class="fas fa-exclamation-triangle me-2"></i> Tài Khoản Đáng Ngờ
            </div>
            <div class="card-body p-0">                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Điểm</th>
                                <th>Đặc điểm</th>
                                <th>Chi tiết</th>
                            </tr>
                        </thead>
                        <tbody id="suspicious-accounts">
                            <tr>
                                <td colspan="4" class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    Đang tải dữ liệu...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Phân trang -->
                <div class="pagination-container d-flex justify-content-center mt-2 mb-2">
                    <nav aria-label="Phân trang tài khoản">
                        <ul class="pagination pagination-sm" id="suspicious-accounts-pagination">
                            <!-- Các nút phân trang sẽ được tạo bằng JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Thêm hàng mới cho hiển thị độ chính xác -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="fas fa-chart-line me-2"></i> Độ chính xác phát hiện gian lận
            </div>
            <div class="card-body">                <div class="row">
                    <div class="col-md-4 text-center">
                        <h5>Precision (Độ chính xác)</h5>
                        <div class="progress mb-2">
                            <div id="precision-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <small class="text-muted">Phần trăm giao dịch phát hiện đúng là gian lận trong số các giao dịch bị đánh dấu</small>
                    </div>
                    <div class="col-md-4 text-center">
                        <h5>Recall (Độ phủ)</h5>
                        <div class="progress mb-2">
                            <div id="recall-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <small class="text-muted">Phần trăm giao dịch gian lận thực sự được phát hiện thành công</small>
                    </div>
                    <div class="col-md-4 text-center">
                        <h5>F1 Score (Điểm tổng hợp)</h5>
                        <div class="progress mb-2">
                            <div id="f1-bar" class="progress-bar bg-warning" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <small class="text-muted">Điểm trung bình cân bằng giữa Precision và Recall</small>
                        <div class="mt-2">
                            <small class="text-muted">F1 = 2 × (Precision × Recall) / (Precision + Recall)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fraud Analysis -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="fas fa-chart-pie me-2"></i> Thống Kê Chi Tiết
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div id="fraud-by-type" style="height: 300px;"></div>
                    </div>
                    <div class="col-md-6">
                        <div id="community-graph" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- Thêm vào phần extra_js -->
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
<script src="{{ url_for('static', filename='js/graph.js') }}"></script>
<script>
// Load data from API
document.addEventListener('DOMContentLoaded', function() {
    // Gọi API theo phương thức bất đồng bộ
    Promise.all([
        fetch('/api/metrics').then(r => r.json()).then(data => {
            console.log("API metrics:", data);
            return data;
        }),
        fetch('/api/suspicious').then(r => r.json()).then(data => {
            console.log("API suspicious:", data);
            return data;
        }),
        fetch('/api/network').then(r => r.json()).then(data => {
            console.log("API network:", data);
            return data;
        }),
        fetch('/api/fraud-stats').then(r => r.json()).then(data => {
            console.log("API fraud-stats:", data);
            return data;
        })
    ])    .then(([metricsData, suspiciousData, networkData, statsData]) => {
        // Kiểm tra dữ liệu
        if (metricsData.has_data) {
            // Cập nhật metrics
            updateMetrics(metricsData.metrics);
            // Cập nhật bảng tài khoản đáng ngờ
            renderSuspiciousAccounts(suspiciousData.suspicious);
            // Vẽ biểu đồ mạng lưới
            if (networkData.network) {
                renderNetwork(networkData.network);
            }
            if (statsData) {
                console.log("Dữ liệu thống kê: ", statsData);
                
                // Vẽ biểu đồ phân loại gian lận nếu có dữ liệu
                if (statsData.fraud_by_type && statsData.fraud_by_type.length > 0) {
                    renderFraudByTypeChart(statsData.fraud_by_type);
                } else {
                    document.getElementById('fraud-by-type').innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-chart-pie text-muted fa-3x mb-3"></i>
                            <p class="mb-1">Không có dữ liệu về loại gian lận</p>
                            <small class="text-muted">Hệ thống chưa phát hiện được các mẫu gian lận theo loại giao dịch</small>
                        </div>
                    `;
                }
                
                // Vẽ biểu đồ phân phối cộng đồng nếu có dữ liệu
                if (statsData.communities && statsData.communities.length > 0) {
                    renderCommunityGraph(statsData.communities);
                } else {
                    document.getElementById('community-graph').innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-users text-muted fa-3x mb-3"></i>
                            <p class="mb-1">Không có dữ liệu về cộng đồng</p>
                            <small class="text-muted">Chưa có cộng đồng tài khoản nào được phát hiện</small>
                        </div>
                    `;
                }

                // Cập nhật độ chính xác
                updateAccuracy(statsData.accuracy);
            } else {
                // Hiển thị thông báo không có dữ liệu nếu statsData không tồn tại
                document.getElementById('fraud-by-type').innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-circle text-warning fa-3x mb-3"></i>
                        <p>Không có dữ liệu thống kê</p>
                        <small>Vui lòng chạy phân tích thêm để thu thập thêm dữ liệu</small>
                    </div>
                `;
                
                document.getElementById('community-graph').innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-circle text-warning fa-3x mb-3"></i>
                        <p>Không có dữ liệu thống kê</p>
                        <small>Vui lòng chạy phân tích thêm để thu thập thêm dữ liệu</small>
                    </div>
                `;
            }
        } else {
            showNoAnalysisMessage();
        }
    })
    .catch(error => {
        console.error('Lỗi khi tải dữ liệu:', error);
        showErrorMessage();
    });
    
    // Cập nhật metrics dashboard và độ chính xác
    function updateMetrics(metrics) {
        document.getElementById('totalAccounts').textContent = metrics.accounts.toLocaleString();
        document.getElementById('totalTransactions').textContent = metrics.transactions.toLocaleString();
          // Lấy số liệu phát hiện gian lận
        const detectedTransactions = metrics.detected_fraud_transactions || 0;
        const fraudAccounts = metrics.fraud || 0;
        const groundTruth = metrics.ground_truth_frauds || 0;
        
        // Hiển thị số giao dịch phát hiện là gian lận và độ chính xác
        document.getElementById('fraudCount').innerHTML = 
            `${detectedTransactions.toLocaleString()} 
             <div class="mt-2">
                <small class="text-muted">Chính xác: ${(metrics.precision * 100).toFixed(1)}%</small><br>
                <small class="text-muted">Recall: ${(metrics.recall * 100).toFixed(1)}%</small><br>
                <small class="text-muted">F1-Score: ${(metrics.f1_score * 100).toFixed(1)}%</small>
             </div>`;
          // Thêm tooltip để hiển thị thông tin chi tiết
        const fraudCardBody = document.querySelector('.card-body:has(#fraudCount)');
        if (fraudCardBody) {
            const tooltipText = `${detectedTransactions.toLocaleString()} giao dịch bị phát hiện là gian lận<br>
                                ${fraudAccounts.toLocaleString()} tài khoản có điểm gian lận > {{fraud_threshold}}`;
            
            fraudCardBody.setAttribute('data-bs-toggle', 'tooltip');
            fraudCardBody.setAttribute('data-bs-html', 'true');
            fraudCardBody.setAttribute('data-bs-placement', 'bottom');
            fraudCardBody.setAttribute('title', tooltipText);
        }
        
        document.getElementById('communityCount').textContent = metrics.communities || "0";
        
        // Tính toán các chỉ số đánh giá hiệu suất
        let precision = 0;
        let recall = 0;
        let f1Score = 0;
        
        // True Positives (TP): Số giao dịch phát hiện đúng là gian lận
        // Giả sử 70% các giao dịch phát hiện được là đúng
        const estimatedTP = Math.min(detectedTransactions, groundTruth) * 0.7;
        
        if (detectedTransactions > 0) {
            precision = (estimatedTP / detectedTransactions) * 100;
        }
        
        if (groundTruth > 0) {
            recall = (estimatedTP / groundTruth) * 100;
        }
        
        if (precision > 0 && recall > 0) {
            f1Score = 2 * (precision * recall) / (precision + recall);
        }
        
        // Cập nhật các thanh tiến trình đánh giá hiệu suất
        updateProgressBar('precision-bar', metrics.precision * 100);
        updateProgressBar('recall-bar', metrics.recall * 100); 
        updateProgressBar('f1-bar', metrics.f1_score * 100);
    }
    
    // Helper function to update progress bars
    function updateProgressBar(id, value) {
        const bar = document.getElementById(id);
        if (!bar) return;
        
        // Round to 1 decimal place
        const roundedValue = Math.round(value * 10) / 10;
        
        // Update bar properties
        bar.style.width = `${roundedValue}%`;
        bar.setAttribute('aria-valuenow', roundedValue);
        bar.textContent = `${roundedValue}%`;
        
        // Update color based on score
        let newClass = 'bg-danger';
        if (roundedValue >= 80) newClass = 'bg-success';
        else if (roundedValue >= 60) newClass = 'bg-info';
        else if (roundedValue >= 40) newClass = 'bg-warning';
        
        // Remove existing bg classes and add new one
        bar.classList.remove('bg-success', 'bg-info', 'bg-warning', 'bg-danger');
        bar.classList.add(newClass);
        
        // Add tooltip
        let tooltipText = '';
        if (id === 'precision-bar') {
            tooltipText = `${roundedValue}% các giao dịch phát hiện là gian lận thực sự đúng`;
        } else if (id === 'recall-bar') {
            tooltipText = `Phát hiện được ${roundedValue}% tổng số giao dịch gian lận thực sự`;
        } else if (id === 'f1-bar') {
            tooltipText = `Điểm F1: ${roundedValue}%`;
        }
        
        bar.setAttribute('data-bs-toggle', 'tooltip');
        bar.setAttribute('data-bs-title', tooltipText);
        
        // Initialize tooltips
        const tooltip = new bootstrap.Tooltip(bar);
    }
    
    function showNoAnalysisMessage() {
        document.getElementById('network-graph').innerHTML = `
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <p class="lead">Chưa có kết quả phân tích.<br>Hãy chạy phân tích gian lận trước!</p>
                    <a href="/" class="btn btn-primary mt-3">Quay lại trang chủ</a>
                </div>
            </div>
        `;
        
        document.getElementById('suspicious-accounts').innerHTML = `
            <tr><td colspan="3" class="text-center py-3">Chưa có kết quả phân tích</td></tr>
        `;
    }
    
    function showErrorMessage() {
        document.getElementById('network-graph').innerHTML = `
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center">
                    <i class="fas fa-exclamation-circle fa-3x text-danger mb-3"></i>
                    <p class="lead">Có lỗi xảy ra khi tải dữ liệu</p>
                    <a href="/results" class="btn btn-primary mt-3">Thử lại</a>
                </div>
            </div>
        `;
    }
      // Render suspicious accounts table
    function renderSuspiciousAccounts(accounts) {
        if (!accounts || accounts.length === 0) {
            document.getElementById('suspicious-accounts').innerHTML = `
                <tr><td colspan="4" class="text-center py-3">Không tìm thấy tài khoản đáng ngờ</td></tr>
            `;
            document.getElementById('suspicious-accounts-pagination').innerHTML = '';
            return;
        }
        
        // Thiết lập phân trang
        const accountsPerPage = 5; // Số tài khoản mỗi trang
        const totalPages = Math.ceil(accounts.length / accountsPerPage);
        let currentPage = 1;
        
        // Hàm hiển thị tài khoản cho trang hiện tại
        function displayAccountsForPage(page) {
            const startIndex = (page - 1) * accountsPerPage;
            const endIndex = Math.min(startIndex + accountsPerPage, accounts.length);
            const accountsToShow = accounts.slice(startIndex, endIndex);
            
            let html = '';            accountsToShow.forEach(account => {                // Xác định đặc điểm của tài khoản dựa trên thuộc tính có sẵn
                let feature = '';
                if (account.in_cycle === 1) feature = 'Vòng tròn giao dịch';
                else if (account.imbalance === 1) feature = 'Mất cân bằng giao dịch';
                else if (account.pagerank > 1.5) feature = 'Trung tâm mạng lưới';
                else if (account.base_score > 0.8) feature = 'Điểm cơ sở cao';
                else if (Math.abs(account.imbalance_amount) > 1000000) feature = 'Chênh lệch lớn';
                else feature = 'Hoạt động bất thường';
                
                // Tạo chi tiết về số lượng giao dịch gửi/nhận
                const details = `Gửi: ${account.sent_count || 0}, Nhận: ${account.received_count || 0}`;
                
                html += `
                <tr>
                    <td>${account.id}</td>
                    <td><span class="badge bg-${getScoreColor(account.score)}">${parseFloat(account.score).toFixed(2)}</span></td>
                    <td>${feature}</td>
                    <td><small>${details}</small></td>
                </tr>
                `;
            });
            
            document.getElementById('suspicious-accounts').innerHTML = html;
        }
        
        // Hàm tạo các nút phân trang
        function createPagination() {
            let paginationHtml = '';
            
            // Nút Previous
            paginationHtml += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" aria-label="Previous" data-page="${currentPage - 1}">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            `;
            
            // Các nút số trang
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `;
            }
            
            // Nút Next
            paginationHtml += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" aria-label="Next" data-page="${currentPage + 1}">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            `;
            
            document.getElementById('suspicious-accounts-pagination').innerHTML = paginationHtml;
            
            // Thêm sự kiện click cho các nút phân trang
            document.querySelectorAll('#suspicious-accounts-pagination .page-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.getAttribute('data-page'));
                    
                    // Chỉ chuyển trang nếu nút không bị disabled
                    if (!this.parentElement.classList.contains('disabled')) {
                        currentPage = page;
                        displayAccountsForPage(currentPage);
                        createPagination();
                    }
                });
            });
        }
          // Hiển thị trang đầu tiên và tạo phân trang
        displayAccountsForPage(currentPage);
        createPagination();
    }
    
    // Lấy màu dựa trên điểm số
    function getScoreColor(score) {
        if (score > 0.8) return 'danger';
        if (score > 0.6) return 'warning';
        if (score > 0.4) return 'info';
        return 'secondary';
    }    // Render Fraud by Type chart
    function renderFraudByTypeChart(data) {
        if (!data || data.length === 0) {
            document.getElementById('fraud-by-type').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-chart-pie text-muted fa-3x mb-3"></i>
                    <p class="mb-1">Không có dữ liệu về loại gian lận</p>
                    <small class="text-muted">Hệ thống chưa phát hiện được các mẫu gian lận theo loại giao dịch</small>
                </div>
            `;
            return;
        }
        
        const chartDom = document.getElementById('fraud-by-type');
        const myChart = echarts.init(chartDom);
          const chartData = data.map(item => ({
            value: item.count,
            name: item.type || 'Khác',
            amount: item.total_amount
        }));        const option = {
            title: {
                text: 'Gian lận theo loại giao dịch',
                left: 'center'
            },
            tooltip: {
                trigger: 'item'
            },
            legend: {
                orient: 'vertical',
                left: 'left'
            },
            series: [
                {
                    name: 'Số lượng gian lận',
                    type: 'pie',
                    radius: '70%',
                    data: chartData,
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }
            ]
        };
        
        myChart.setOption(option);
        
        // Responsive chart
        window.addEventListener('resize', function() {
            myChart.resize();
        });
    }    // Render Community Graph
    function renderCommunityGraph(data) {
        if (!data || data.length === 0) return;
        
        const chartDom = document.getElementById('community-graph');
        const myChart = echarts.init(chartDom);
        
        const communities = data.map(item => 'C' + item.community);
        const counts = data.map(item => item.count);
        
        const option = {
            title: {
                text: 'Phân phối cộng đồng',
                left: 'center'
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                }
            },
            xAxis: {
                type: 'category',
                data: communities
            },
            yAxis: {
                type: 'value',
                name: 'Số tài khoản'
            },
            series: [
                {
                    data: counts,
                    type: 'bar',
                    colorBy: 'data'
                }
            ]
        };
        
        myChart.setOption(option);
        
        // Responsive chart
        window.addEventListener('resize', function() {
            myChart.resize();
        });
    }

    // Network visualization function - ADD THIS
    function renderNetwork(network) {
        console.log("Rendering network with:", network);
        
        // Check if we have data
        if (!network.nodes || network.nodes.length === 0) {
            document.getElementById('network-graph').innerHTML = `
                <div class="d-flex justify-content-center align-items-center h-100">
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <p class="lead">Không có dữ liệu mạng lưới để hiển thị.</p>
                    </div>
                </div>
            `;
            return;
        }
        
        // Clear the container
        document.getElementById('network-graph').innerHTML = '';
        
        // Create SVG
        const width = document.getElementById('network-graph').clientWidth;
        const height = 500;
        
        const svg = d3.select('#network-graph')
            .append('svg')
            .attr('width', width)
            .attr('height', height);
        
        // Add zoom capability
        const g = svg.append('g');
        const zoom = d3.zoom()
            .scaleExtent([0.1, 3])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });
        
        svg.call(zoom);
        
        // Create simulation
        const simulation = d3.forceSimulation(network.nodes)
            .force('link', d3.forceLink(network.links).id(d => d.id).distance(100))
            .force('charge', d3.forceManyBody().strength(-300))
            .force('center', d3.forceCenter(width / 2, height / 2));
        
        // Add links
        const link = g.append('g')
            .selectAll('line')
            .data(network.links)
            .enter().append('line')
            .attr('stroke-width', d => Math.sqrt(d.value || 1))
            .attr('stroke', d => d.is_fraud ? '#ff4136' : '#aaa');
        
        // Add nodes
        const node = g.append('g')
            .selectAll('circle')
            .data(network.nodes)
            .enter().append('circle')
            .attr('r', d => 5 + (d.score || 0) * 5)
            .attr('fill', d => {
                const score = d.score || 0;
                if (score > 0.7) return '#ff4136'; // Red
                if (score > 0.5) return '#ff851b'; // Orange
                return '#0074d9'; // Blue
            })
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended));
        
        // Add tooltips
        node.append('title')
            .text(d => `ID: ${d.id}\nScore: ${(d.score || 0).toFixed(2)}`);
        
        // Update positions
        simulation.on('tick', () => {
            link
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);
            
            node
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);
        });
        
        // Connect zoom controls
        document.getElementById('zoomIn').addEventListener('click', function() {
            svg.transition().duration(500).call(zoom.scaleBy, 1.5);
        });
        
        document.getElementById('zoomOut').addEventListener('click', function() {
            svg.transition().duration(500).call(zoom.scaleBy, 0.7);
        });
        
        document.getElementById('resetZoom').addEventListener('click', function() {
            svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
        });
        
        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    }

    // Update accuracy metrics
    function updateAccuracy(accuracy) {
        if (!accuracy) return;

        const precision = accuracy.precision || 0;
        const recall = accuracy.recall || 0;
        const f1 = accuracy.f1 || 0;

        document.getElementById('precision-bar').style.width = `${precision * 100}%`;
        document.getElementById('precision-bar').setAttribute('aria-valuenow', precision * 100);
        document.getElementById('precision-bar').textContent = `${(precision * 100).toFixed(2)}%`;

        document.getElementById('recall-bar').style.width = `${recall * 100}%`;
        document.getElementById('recall-bar').setAttribute('aria-valuenow', recall * 100);
        document.getElementById('recall-bar').textContent = `${(recall * 100).toFixed(2)}%`;

        document.getElementById('f1-bar').style.width = `${f1 * 100}%`;
        document.getElementById('f1-bar').setAttribute('aria-valuenow', f1 * 100);
        document.getElementById('f1-bar').textContent = `${(f1 * 100).toFixed(2)}%`;
    }
});

// Zoom controls for network graph
document.getElementById('zoomIn').addEventListener('click', function() {
    // Will be implemented when D3.js graph is ready
    console.log('Zoom in');
});

document.getElementById('zoomOut').addEventListener('click', function() {
    // Will be implemented when D3.js graph is ready
    console.log('Zoom out');
});

document.getElementById('resetZoom').addEventListener('click', function() {
    // Will be implemented when D3.js graph is ready
    console.log('Reset zoom');
});
</script>
{% endblock %}