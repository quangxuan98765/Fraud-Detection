{% extends 'layout.html' %}

{% block title %}Kết Quả Phân Tích Gian Lận{% endblock %}

{% block extra_css %}
<style>
.node-chart {
    height: 500px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #f8f9fa;
}
.metric-card {
    transition: transform 0.3s ease;
}
.metric-card:hover {
    transform: translateY(-5px);
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-12">
        <h1 class="display-5 mb-3">Kết Quả Phân Tích Gian Lận</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Trang chủ</a></li>
                <li class="breadcrumb-item active" aria-current="page">Kết quả</li>
            </ol>
        </nav>
    </div>
</div>

<!-- Dashboard chính -->
<div class="row mb-4">
    <!-- Metric Cards -->
    <div class="col-md-3">
        <div class="card metric-card border-primary text-center mb-3">
            <div class="card-body">
                <h5 class="card-title text-primary">Tài khoản</h5>
                <p class="display-5 mb-0" id="totalAccounts">...</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card metric-card border-success text-center mb-3">
            <div class="card-body">
                <h5 class="card-title text-success">Giao dịch</h5>
                <p class="display-5 mb-0" id="totalTransactions">...</p>
            </div>
        </div>    </div>    <div class="col-md-3">        <div class="card metric-card border-danger text-center mb-3" style="cursor: pointer;" onclick="showFraudTransactions()">            <div class="card-body">
                <h5 class="card-title text-danger">Giao dịch bị phát hiện</h5>
                <p class="display-5 mb-0" id="fraudCount">...</p>
                <small class="text-muted">(fraud_score > {{ fraud_threshold }})</small>
                <br>
                <small class="text-muted">Click để xem chi tiết các giao dịch</small>
            </div>
        </div>
    </div>    <div class="col-md-3">
        <div class="card metric-card border-warning text-center mb-3" id="risk-community-card">
            <div class="card-body">
                <h5 class="card-title text-warning">Cộng đồng Rủi ro</h5>
                <p class="display-5 mb-0" id="highRiskCommunityCount">...</p>
                <small class="text-muted">(Nhóm ≥ 2 tài khoản có điểm gian lận cao)</small>
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-warning" id="showCommunitiesBtn">
                        <i class="fas fa-eye"></i> Xem chi tiết
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Biểu đồ và Bảng -->
<div class="row mb-4">
    <!-- Network Graph -->
    <div class="col-lg-8">
        <div class="card mb-4">            <div class="card-header bg-primary text-white">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-network-wired me-2"></i> Biểu Đồ Mạng Lưới Gian Lận</span>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-light shadow-sm" id="zoomIn" title="Phóng to">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button class="btn btn-sm btn-light shadow-sm" id="zoomOut" title="Thu nhỏ">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button class="btn btn-sm btn-light shadow-sm" id="resetZoom" title="Đặt lại">
                            <i class="fas fa-sync"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="alert alert-primary mb-0 rounded-0 border-0 py-2">
                    <small>
                        <b>Hướng dẫn:</b> 
                        <i class="fas fa-mouse-pointer text-muted"></i> Kéo node để di chuyển | 
                        <i class="fas fa-search-plus text-muted"></i> Cuộn chuột để phóng to/nhỏ | 
                        <i class="fas fa-hand-pointer text-muted"></i> Di chuột qua node để xem chi tiết
                    </small>
                </div>
                <div id="network-graph" class="node-chart">
                    <!-- D3.js graph will be rendered here -->
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="lead">Đang tải biểu đồ...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Suspicious Accounts -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <i class="fas fa-exclamation-triangle me-2"></i> Tài Khoản Đáng Ngờ
            </div>
            <div class="card-body p-0">                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Điểm</th>
                                <th>Đặc điểm</th>
                                <th>Chi tiết</th>
                            </tr>
                        </thead>
                        <tbody id="suspicious-accounts">
                            <tr>
                                <td colspan="4" class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    Đang tải dữ liệu...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Phân trang -->
                <div class="pagination-container d-flex justify-content-center mt-2 mb-2">
                    <nav aria-label="Phân trang tài khoản">
                        <ul class="pagination pagination-sm" id="suspicious-accounts-pagination">
                            <!-- Các nút phân trang sẽ được tạo bằng JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Thêm hàng mới cho hiển thị độ chính xác -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="fas fa-chart-line me-2"></i> Độ chính xác phát hiện gian lận
            </div>
            <div class="card-body">                <div class="row">
                    <div class="col-md-4 text-center">
                        <h5>Precision (Độ chính xác)</h5>
                        <div class="progress mb-2">
                            <div id="precision-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <small class="text-muted">Phần trăm giao dịch phát hiện đúng là gian lận trong số các giao dịch bị đánh dấu</small>
                    </div>
                    <div class="col-md-4 text-center">
                        <h5>Recall (Độ phủ)</h5>
                        <div class="progress mb-2">
                            <div id="recall-bar" class="progress-bar bg-info" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <small class="text-muted">Phần trăm giao dịch gian lận thực sự được phát hiện thành công</small>
                    </div>
                    <div class="col-md-4 text-center">
                        <h5>F1 Score (Điểm tổng hợp)</h5>
                        <div class="progress mb-2">
                            <div id="f1-bar" class="progress-bar bg-warning" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <small class="text-muted">Điểm trung bình cân bằng giữa Precision và Recall</small>
                        <div class="mt-2">
                            <small class="text-muted">F1 = 2 × (Precision × Recall) / (Precision + Recall)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fraud Analysis -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="fas fa-chart-pie me-2"></i> Thống Kê Chi Tiết
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div id="fraud-by-type" style="height: 300px;"></div>
                    </div>                    <div class="col-md-6">
                        <div class="card mb-3 shadow-sm">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-users-cog me-2"></i> Phân Tích Cộng Đồng Rủi Ro</span>
                                <button id="showCommunitiesBtn" class="btn btn-sm btn-light">
                                    <i class="fas fa-search me-1"></i> Xem chi tiết
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div class="alert alert-primary mb-0 rounded-0 border-0 py-2">
                                    <small>
                                        <b>Phân tích:</b> Hiển thị top 10 cộng đồng rủi ro cao nhất được phát hiện trong hệ thống.
                                    </small>
                                </div>
                                <div id="community-graph" style="height: 300px; position: relative;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                  <!-- Thêm biểu đồ phân phối kích thước cộng đồng -->
                <!-- Đã loại bỏ biểu đồ kích thước cộng đồng theo yêu cầu -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- Thêm vào phần extra_js -->
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
<script src="{{ url_for('static', filename='js/graph.js') }}"></script>
<script>
// Load data from API
document.addEventListener('DOMContentLoaded', function() {
    // Gọi API theo phương thức bất đồng bộ
    Promise.all([
        fetch('/api/metrics').then(r => r.json()).then(data => {
            console.log("API metrics:", data);
            return data;
        }),
        fetch('/api/suspicious').then(r => r.json()).then(data => {
            console.log("API suspicious:", data);
            return data;
        }),
        fetch('/api/network').then(r => r.json()).then(data => {
            console.log("API network:", data);
            return data;
        }),
        fetch('/api/fraud-stats').then(r => r.json()).then(data => {
            console.log("API fraud-stats:", data);
            return data;
        })
    ])    .then(([metricsData, suspiciousData, networkData, statsData]) => {
        // Kiểm tra dữ liệu
        if (metricsData.has_data) {
            // Cập nhật metrics
            updateMetrics(metricsData.metrics);
            // Cập nhật bảng tài khoản đáng ngờ
            renderSuspiciousAccounts(suspiciousData.suspicious);
            // Vẽ biểu đồ mạng lưới
            if (networkData.network) {
                renderNetwork(networkData.network);
            }
            if (statsData) {
                console.log("Dữ liệu thống kê: ", statsData);
                
                // Vẽ biểu đồ phân loại gian lận nếu có dữ liệu
                if (statsData.fraud_by_type && statsData.fraud_by_type.length > 0) {
                    renderFraudByTypeChart(statsData.fraud_by_type);
                } else {
                    document.getElementById('fraud-by-type').innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-chart-pie text-muted fa-3x mb-3"></i>
                            <p class="mb-1">Không có dữ liệu về loại gian lận</p>
                            <small class="text-muted">Hệ thống chưa phát hiện được các mẫu gian lận theo loại giao dịch</small>
                        </div>
                    `;
                }                    // Vẽ biểu đồ phân phối cộng đồng nếu có dữ liệu
                    if (statsData.communities && statsData.communities.length > 0) {
                        renderCommunityGraph(statsData.communities);
                        
                        // Thêm tiêu đề giải thích cho biểu đồ cộng đồng
                        document.querySelector(".card:has(#community-graph) .card-header").innerHTML = 
                            '<i class="fas fa-users-cog me-2"></i> Phân Tích Cộng Đồng Rủi Ro';
                    } else {
                        document.getElementById('community-graph').innerHTML = `
                            <div class="text-center py-5">
                                <i class="fas fa-users text-muted fa-3x mb-3"></i>
                                <p class="mb-1">Không có dữ liệu về cộng đồng</p>
                                <small class="text-muted">Chưa có cộng đồng tài khoản nào được phát hiện</small>
                            </div>
                        `;
                    }

                // Cập nhật độ chính xác
                updateAccuracy(statsData.accuracy);
            } else {
                // Hiển thị thông báo không có dữ liệu nếu statsData không tồn tại
                document.getElementById('fraud-by-type').innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-circle text-warning fa-3x mb-3"></i>
                        <p>Không có dữ liệu thống kê</p>
                        <small>Vui lòng chạy phân tích thêm để thu thập thêm dữ liệu</small>
                    </div>
                `;
                
                document.getElementById('community-graph').innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-circle text-warning fa-3x mb-3"></i>
                        <p>Không có dữ liệu thống kê</p>
                        <small>Vui lòng chạy phân tích thêm để thu thập thêm dữ liệu</small>
                    </div>
                `;
            }
        } else {
            showNoAnalysisMessage();
        }
    })
    .catch(error => {
        console.error('Lỗi khi tải dữ liệu:', error);
        showErrorMessage();
    });
    
    // Cập nhật metrics dashboard và độ chính xác
    function updateMetrics(metrics) {        document.getElementById('totalAccounts').textContent = metrics.accounts.toLocaleString();
        document.getElementById('totalTransactions').textContent = metrics.transactions.toLocaleString();
          // Lấy số liệu phát hiện gian lận
        const detectedTransactions = metrics.detected_fraud_transactions || 0;
        const fraudAccounts = metrics.fraud || 0;
        const groundTruth = metrics.ground_truth_frauds || 0;
        
        // Hiển thị số giao dịch phát hiện là gian lận và độ chính xác
        document.getElementById('fraudCount').innerHTML = 
            `${detectedTransactions.toLocaleString()} 
             <div class="mt-2">
                <small class="text-muted">Chính xác: ${(metrics.precision * 100).toFixed(1)}%</small><br>
                <small class="text-muted">Recall: ${(metrics.recall * 100).toFixed(1)}%</small><br>
                <small class="text-muted">F1-Score: ${(metrics.f1_score * 100).toFixed(1)}%</small>
             </div>`;
          // Thêm tooltip để hiển thị thông tin chi tiết
        const fraudCardBody = document.querySelector('.card-body:has(#fraudCount)');
        if (fraudCardBody) {
            const tooltipText = `${detectedTransactions.toLocaleString()} giao dịch bị phát hiện là gian lận<br>
                                ${fraudAccounts.toLocaleString()} tài khoản có điểm gian lận > {{fraud_threshold}}`;
            
            fraudCardBody.setAttribute('data-bs-toggle', 'tooltip');
            fraudCardBody.setAttribute('data-bs-html', 'true');
            fraudCardBody.setAttribute('data-bs-placement', 'bottom');
            fraudCardBody.setAttribute('title', tooltipText);
        }
        
        // Hiển thị số cộng đồng có rủi ro cao
        document.getElementById('highRiskCommunityCount').textContent = metrics.high_risk_communities || "0";
        
        // Tính toán các chỉ số đánh giá hiệu suất
        let precision = 0;
        let recall = 0;
        let f1Score = 0;
        
        // True Positives (TP): Số giao dịch phát hiện đúng là gian lận
        // Giả sử 70% các giao dịch phát hiện được là đúng
        const estimatedTP = Math.min(detectedTransactions, groundTruth) * 0.7;
        
        if (detectedTransactions > 0) {
            precision = (estimatedTP / detectedTransactions) * 100;
        }
        
        if (groundTruth > 0) {
            recall = (estimatedTP / groundTruth) * 100;
        }
        
        if (precision > 0 && recall > 0) {
            f1Score = 2 * (precision * recall) / (precision + recall);
        }
        
        // Cập nhật các thanh tiến trình đánh giá hiệu suất
        updateProgressBar('precision-bar', metrics.precision * 100);
        updateProgressBar('recall-bar', metrics.recall * 100); 
        updateProgressBar('f1-bar', metrics.f1_score * 100);
    }
    
    // Helper function to update progress bars
    function updateProgressBar(id, value) {
        const bar = document.getElementById(id);
        if (!bar) return;
        
        // Round to 1 decimal place
        const roundedValue = Math.round(value * 10) / 10;
        
        // Update bar properties
        bar.style.width = `${roundedValue}%`;
        bar.setAttribute('aria-valuenow', roundedValue);
        bar.textContent = `${roundedValue}%`;
        
        // Update color based on score
        let newClass = 'bg-danger';
        if (roundedValue >= 80) newClass = 'bg-success';
        else if (roundedValue >= 60) newClass = 'bg-info';
        else if (roundedValue >= 40) newClass = 'bg-warning';
        
        // Remove existing bg classes and add new one
        bar.classList.remove('bg-success', 'bg-info', 'bg-warning', 'bg-danger');
        bar.classList.add(newClass);
        
        // Add tooltip
        let tooltipText = '';
        if (id === 'precision-bar') {
            tooltipText = `${roundedValue}% các giao dịch phát hiện là gian lận thực sự đúng`;
        } else if (id === 'recall-bar') {
            tooltipText = `Phát hiện được ${roundedValue}% tổng số giao dịch gian lận thực sự`;
        } else if (id === 'f1-bar') {
            tooltipText = `Điểm F1: ${roundedValue}%`;
        }
        
        bar.setAttribute('data-bs-toggle', 'tooltip');
        bar.setAttribute('data-bs-title', tooltipText);
        
        // Initialize tooltips
        const tooltip = new bootstrap.Tooltip(bar);
    }
    
    function showNoAnalysisMessage() {
        document.getElementById('network-graph').innerHTML = `
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <p class="lead">Chưa có kết quả phân tích.<br>Hãy chạy phân tích gian lận trước!</p>
                    <a href="/" class="btn btn-primary mt-3">Quay lại trang chủ</a>
                </div>
            </div>
        `;
        
        document.getElementById('suspicious-accounts').innerHTML = `
            <tr><td colspan="3" class="text-center py-3">Chưa có kết quả phân tích</td></tr>
        `;
    }
    
    function showErrorMessage() {
        document.getElementById('network-graph').innerHTML = `
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center">
                    <i class="fas fa-exclamation-circle fa-3x text-danger mb-3"></i>
                    <p class="lead">Có lỗi xảy ra khi tải dữ liệu</p>
                    <a href="/results" class="btn btn-primary mt-3">Thử lại</a>
                </div>
            </div>
        `;
    }
      // Render suspicious accounts table
    function renderSuspiciousAccounts(accounts) {
        if (!accounts || accounts.length === 0) {
            document.getElementById('suspicious-accounts').innerHTML = `
                <tr><td colspan="4" class="text-center py-3">Không tìm thấy tài khoản đáng ngờ</td></tr>
            `;
            document.getElementById('suspicious-accounts-pagination').innerHTML = '';
            return;
        }
        
        // Thiết lập phân trang
        const accountsPerPage = 5; // Số tài khoản mỗi trang
        const totalPages = Math.ceil(accounts.length / accountsPerPage);
        let currentPage = 1;
        
        // Hàm hiển thị tài khoản cho trang hiện tại
        function displayAccountsForPage(page) {
            const startIndex = (page - 1) * accountsPerPage;
            const endIndex = Math.min(startIndex + accountsPerPage, accounts.length);
            const accountsToShow = accounts.slice(startIndex, endIndex);
            
            let html = '';            accountsToShow.forEach(account => {                // Xác định đặc điểm của tài khoản dựa trên thuộc tính có sẵn
                let feature = '';
                if (account.in_cycle === 1) feature = 'Vòng tròn giao dịch';
                else if (account.imbalance === 1) feature = 'Mất cân bằng giao dịch';
                else if (account.pagerank > 1.5) feature = 'Trung tâm mạng lưới';
                else if (account.base_score > 0.8) feature = 'Điểm cơ sở cao';
                else if (Math.abs(account.imbalance_amount) > 1000000) feature = 'Chênh lệch lớn';
                else feature = 'Hoạt động bất thường';
                
                // Tạo chi tiết về số lượng giao dịch gửi/nhận
                const details = `Gửi: ${account.sent_count || 0}, Nhận: ${account.received_count || 0}`;
                
                html += `
                <tr>
                    <td>${account.id}</td>
                    <td><span class="badge bg-${getScoreColor(account.score)}">${parseFloat(account.score).toFixed(2)}</span></td>
                    <td>${feature}</td>
                    <td><small>${details}</small></td>
                </tr>
                `;
            });
            
            document.getElementById('suspicious-accounts').innerHTML = html;
        }
        
        // Hàm tạo các nút phân trang
        function createPagination() {
            let paginationHtml = '';
            
            // Nút Previous
            paginationHtml += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" aria-label="Previous" data-page="${currentPage - 1}">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            `;
            
            // Các nút số trang
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `;
            }
            
            // Nút Next
            paginationHtml += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" aria-label="Next" data-page="${currentPage + 1}">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            `;
            
            document.getElementById('suspicious-accounts-pagination').innerHTML = paginationHtml;
            
            // Thêm sự kiện click cho các nút phân trang
            document.querySelectorAll('#suspicious-accounts-pagination .page-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.getAttribute('data-page'));
                    
                    // Chỉ chuyển trang nếu nút không bị disabled
                    if (!this.parentElement.classList.contains('disabled')) {
                        currentPage = page;
                        displayAccountsForPage(currentPage);
                        createPagination();
                    }
                });
            });
        }
          // Hiển thị trang đầu tiên và tạo phân trang
        displayAccountsForPage(currentPage);
        createPagination();
    }
    
    // Lấy màu dựa trên điểm số
    function getScoreColor(score) {
        if (score > 0.8) return 'danger';
        if (score > 0.6) return 'warning';
        if (score > 0.4) return 'info';
        return 'secondary';
    }    // Render Fraud by Type chart
    function renderFraudByTypeChart(data) {
        if (!data || data.length === 0) {
            document.getElementById('fraud-by-type').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-chart-pie text-muted fa-3x mb-3"></i>
                    <p class="mb-1">Không có dữ liệu về loại gian lận</p>
                    <small class="text-muted">Hệ thống chưa phát hiện được các mẫu gian lận theo loại giao dịch</small>
                </div>
            `;
            return;
        }
        
        const chartDom = document.getElementById('fraud-by-type');
        const myChart = echarts.init(chartDom);
          const chartData = data.map(item => ({
            value: item.count,
            name: item.type || 'Khác',
            amount: item.total_amount
        }));        const option = {
            title: {
                text: 'Gian lận theo loại giao dịch',
                left: 'center'
            },
            tooltip: {
                trigger: 'item'
            },
            legend: {
                orient: 'vertical',
                left: 'left'
            },
            series: [
                {
                    name: 'Số lượng gian lận',
                    type: 'pie',
                    radius: '70%',
                    data: chartData,
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }
            ]
        };
        
        myChart.setOption(option);
        
        // Responsive chart
        window.addEventListener('resize', function() {
            myChart.resize();
        });
    }    // Hàm vẽ biểu đồ cộng đồng
    function renderCommunityGraph(data) {
        if (!data || data.length === 0) {
            document.getElementById('community-graph').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-users text-muted fa-3x mb-3"></i>
                    <p class="mb-1">Không có dữ liệu về cộng đồng</p>
                    <small class="text-muted">Chưa có cộng đồng tài khoản nào được phát hiện</small>
                </div>
            `;
            return;
        }
        
        const chartDom = document.getElementById('community-graph');
        const myChart = echarts.init(chartDom);
        
        // Sắp xếp và lọc dữ liệu
        const chartData = data
            .filter(item => item.count >= 2) // Chỉ hiển thị cộng đồng có ít nhất 2 tài khoản
            .sort((a, b) => b.risk_ratio - a.risk_ratio) // Sắp xếp theo tỷ lệ rủi ro
            .slice(0, 10) // Lấy 10 cộng đồng rủi ro nhất
            .map(item => {
                const riskPercent = Math.round(item.risk_ratio * 100);
                return {
                    value: item.count,
                    name: `ID: ${item.community} (${item.count} tài khoản)`,
                    community: item.community,
                    avg_score: item.avg_score,
                    high_risk: item.high_risk_count,
                    risk_ratio: riskPercent,
                    itemStyle: {
                        color: getColorByRiskScore(item.avg_score)
                    }
                };
            });
            
        const option = {
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    return `<div style="font-weight:bold;border-bottom:1px solid #ddd;margin-bottom:5px;padding-bottom:5px">
                                Cộng đồng #${params.data.community}
                            </div>
                            <div>Số tài khoản: <b>${params.data.value}</b></div>
                            <div>Điểm gian lận TB: <b>${params.data.avg_score.toFixed(2)}</b></div>
                            <div>Tài khoản rủi ro cao: <b>${params.data.high_risk}</b></div>
                            <div>Tỷ lệ rủi ro: <b>${params.data.risk_ratio}%</b></div>
                            <div style="margin-top:5px;font-style:italic;color:#999">Nhấn để xem chi tiết</div>`;
                }
            },
            series: [
                {
                    name: 'Cộng đồng rủi ro',
                    type: 'pie',
                    radius: ['30%', '70%'],
                    avoidLabelOverlap: true,
                    itemStyle: {
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    label: {
                        show: false
                    },
                    emphasis: {
                        label: {
                            show: true,
                            formatter: '{b}',
                            fontSize: 12
                        },
                        itemStyle: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: chartData
                }
            ]
        };
        
        myChart.setOption(option);
        
        // Thêm sự kiện click cho biểu đồ để hiển thị thông tin chi tiết của cộng đồng
        myChart.on('click', function(params) {
            if (params.data && params.data.community) {
                showCommunityDetails(params.data.community);
            }
        });
        
        // Responsive chart
        window.addEventListener('resize', function() {
            myChart.resize();
        });
        
        // Helper function để lấy màu dựa trên điểm rủi ro
        function getColorByRiskScore(score) {
            if (score > 0.7) return '#dc3545'; // Đỏ - Rủi ro cao
            if (score > 0.5) return '#fd7e14'; // Cam - Rủi ro trung bình
            if (score > 0.3) return '#ffc107'; // Vàng - Rủi ro thấp
            return '#20c997'; // Xanh lá - Bình thường
        }
        
        // Hàm mở modal chi tiết cộng đồng
        function showCommunityDetails(communityId) {
            // Gọi hàm trong community_viewer.js
            if (typeof window.showCommunityDetails === 'function') {
                window.showCommunityDetails(communityId);
            } else {
                // Nếu chưa tải được hàm, mở modal danh sách cộng đồng
                if (document.getElementById('showCommunitiesBtn')) {
                    document.getElementById('showCommunitiesBtn').click();
                }
            }
        }
    }
      // Hàm vẽ biểu đồ phân phối kích thước cộng đồng mới
    // Đã loại bỏ hàm renderCommunityDistribution theo yêu cầu    // Network visualization function - ADD THIS
    function renderNetwork(network) {
        console.log("Rendering network with:", network);
        
        // Check if we have data
        if (!network.nodes || network.nodes.length === 0) {
            document.getElementById('network-graph').innerHTML = `
                <div class="d-flex justify-content-center align-items-center h-100">
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                        <p class="lead">Không có dữ liệu mạng lưới để hiển thị.</p>
                    </div>
                </div>
            `;
            return;
        }
        
        // Clear the container
        document.getElementById('network-graph').innerHTML = '';
        
        // Create SVG
        const width = document.getElementById('network-graph').clientWidth;
        const height = 530;
        
        // Create tooltip div
        const tooltip = d3.select('#network-graph')
            .append('div')
            .attr('class', 'node-tooltip');
            
        // Create legend
        const legend = d3.select('#network-graph')
            .append('div')
            .attr('class', 'network-legend')
            .html(`
                <div style="font-weight: bold; margin-bottom: 8px;">Chú thích:</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff4136;"></div>
                    <div>Tài khoản rủi ro cao</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff851b;"></div>
                    <div>Tài khoản đáng ngờ</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #0074d9;"></div>
                    <div>Tài khoản bình thường</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: transparent; border: 2px dashed #ff4136;"></div>
                    <div>Giao dịch gian lận</div>
                </div>
                <div style="font-size: 10px; color: #666; margin-top: 5px;">
                    Kích thước nút tương ứng với điểm rủi ro
                </div>
            `);
            
        const svg = d3.select('#network-graph')
            .append('svg')
            .attr('width', width)
            .attr('height', height);
            
        // Add background glow filter for highlighted nodes
        const defs = svg.append('defs');
        const filter = defs.append('filter')
            .attr('id', 'glow');
            
        filter.append('feGaussianBlur')
            .attr('stdDeviation', '3.5')
            .attr('result', 'coloredBlur');
            
        const feMerge = filter.append('feMerge');
        feMerge.append('feMergeNode')
            .attr('in', 'coloredBlur');
        feMerge.append('feMergeNode')
            .attr('in', 'SourceGraphic');
        
        // Add zoom capability
        const g = svg.append('g');
        const zoom = d3.zoom()
            .scaleExtent([0.1, 5])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
                // Hide tooltip on zoom
                tooltip.style('display', 'none');
            });
        
        svg.call(zoom);
        
        // Apply initial zoom to fit the network better
        svg.call(zoom.transform, d3.zoomIdentity.scale(0.8).translate(width / 5, height / 5));
        
        // Create simulation with improved physics
        const simulation = d3.forceSimulation(network.nodes)
            .force('link', d3.forceLink(network.links).id(d => d.id).distance(d => {
                // Make fraud links shorter to cluster fraud nodes
                return d.is_fraud ? 80 : 120;
            }))
            .force('charge', d3.forceManyBody().strength(d => {
                // Higher repulsion for fraud nodes
                return d.score > 0.7 ? -500 : -300;
            }))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('x', d3.forceX(width / 2).strength(0.05))
            .force('y', d3.forceY(height / 2).strength(0.05))
            .force('collision', d3.forceCollide().radius(d => 10 + (d.score || 0) * 10).strength(0.7));
        
        // Add highlighted links with glow for fraud transactions
        const linkHighlight = g.append('g')
            .attr('class', 'link-highlights')
            .selectAll('line')
            .data(network.links.filter(d => d.is_fraud))
            .enter().append('line')
            .attr('stroke', '#ff4136')
            .attr('stroke-width', d => Math.sqrt(d.value || 1) * 1.5)
            .attr('opacity', 0.2)
            .attr('stroke-linecap', 'round');
        
        // Add links
        const link = g.append('g')
            .selectAll('line')
            .data(network.links)
            .enter().append('line')
            .attr('class', d => 'link ' + (d.is_fraud ? 'fraud' : 'normal'))
            .attr('stroke-width', d => {
                // Scale link width based on value but keep it reasonable
                const baseWidth = Math.sqrt(d.value || 1) / 15;
                return Math.max(0.5, Math.min(baseWidth, 3));
            });
            
        // Add node halos for high fraud score nodes
        const nodeHalo = g.append('g')
            .selectAll('circle')
            .data(network.nodes.filter(d => d.score > 0.7))
            .enter().append('circle')
            .attr('r', d => (5 + (d.score || 0) * 5) * 1.5)
            .attr('fill', '#ff4136')
            .attr('opacity', 0.2)
            .attr('filter', 'url(#glow)');
            
        // Add nodes
        const node = g.append('g')
            .selectAll('circle')
            .data(network.nodes)
            .enter().append('circle')
            .attr('class', 'node')
            .attr('r', d => 5 + (d.score || 0) * 5)
            .attr('fill', d => {
                const score = d.score || 0;
                if (score > 0.7) return '#ff4136'; // Red - Rủi ro cao
                if (score > 0.5) return '#ff851b'; // Orange - Rủi ro trung bình
                return '#0074d9'; // Blue - Bình thường
            })
            .style('filter', d => d.score > 0.8 ? 'url(#glow)' : null)
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended));
                
        // Add labels for high risk nodes
        const labels = g.append('g')
            .selectAll('text')
            .data(network.nodes.filter(d => d.score > 0.8))
            .enter()
            .append('text')
            .text(d => d.id)
            .attr('font-size', 9)
            .attr('fill', '#fff')
            .attr('text-anchor', 'middle')
            .attr('dy', d => -(8 + (d.score || 0) * 4))
            .attr('pointer-events', 'none')
            .attr('text-shadow', '0 1px 2px rgba(0,0,0,0.9)')
            .style('user-select', 'none');
        
        // Better tooltips with hover effects
        node.on('mouseover', function(event, d) {
                // Highlight connected nodes and links
                const connectedNodes = new Set();
                const nodeId = d.id;
                
                // Find all connected nodes
                network.links.forEach(link => {
                    if (link.source.id === nodeId || link.target.id === nodeId) {
                        connectedNodes.add(typeof link.source === 'object' ? link.source.id : link.source);
                        connectedNodes.add(typeof link.target === 'object' ? link.target.id : link.target);
                    }
                });
                
                // Dim unconnected nodes
                node.style('opacity', n => connectedNodes.has(n.id) ? 1 : 0.3);
                nodeHalo.style('opacity', n => connectedNodes.has(n.id) ? 0.3 : 0.1);
                
                // Highlight connected links
                link.style('opacity', l => 
                    (l.source.id === nodeId || l.target.id === nodeId) ? 1 : 0.1)
                    .style('stroke-width', l => 
                        (l.source.id === nodeId || l.target.id === nodeId) 
                        ? (l.is_fraud ? 2 : 1.5) : (Math.sqrt(l.value || 1) / 15));
                
                // Show tooltip with more details
                tooltip
                    .style('display', 'block')
                    .style('left', (event.pageX - document.getElementById('network-graph').getBoundingClientRect().left + 10) + 'px')
                    .style('top', (event.pageY - document.getElementById('network-graph').getBoundingClientRect().top - 30) + 'px')
                    .html(`<div style="font-weight:bold;border-bottom:1px solid #aaa;margin-bottom:4px">
                             Tài khoản: ${d.id}
                           </div>
                           <div>Điểm gian lận: <span style="font-weight:bold;color:${d.score > 0.7 ? '#ff4136' : d.score > 0.5 ? '#ff851b' : '#0074d9'}">
                             ${(d.score || 0).toFixed(2)}
                           </span></div>
                           <div>Phân loại: <span style="font-weight:bold">
                             ${d.score > 0.7 ? 'RỦI RO CAO' : d.score > 0.5 ? 'ĐÁNG NGỜ' : 'BÌNH THƯỜNG'}
                           </span></div>
                           <div style="font-style:italic;margin-top:4px;font-size:10px">
                             ${connectedNodes.size - 1} kết nối
                           </div>`);
            })
            .on('mouseout', function() {
                // Restore all nodes and links
                node.style('opacity', 1);
                nodeHalo.style('opacity', 0.2);
                link.style('opacity', 0.6)
                    .style('stroke-width', d => {
                        const baseWidth = Math.sqrt(d.value || 1) / 15;
                        return Math.max(0.5, Math.min(baseWidth, 3));
                    });
                
                // Hide tooltip
                tooltip.style('display', 'none');
            });

        // Update positions
        simulation.on('tick', () => {
            link
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);
                
            linkHighlight
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);
            
            node
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);
                
            nodeHalo
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);
                
            labels
                .attr('x', d => d.x)
                .attr('y', d => d.y);
        });
        
        // Connect zoom controls
        document.getElementById('zoomIn').addEventListener('click', function() {
            svg.transition().duration(500).call(zoom.scaleBy, 1.5);
        });
        
        document.getElementById('zoomOut').addEventListener('click', function() {
            svg.transition().duration(500).call(zoom.scaleBy, 0.7);
        });
        
        document.getElementById('resetZoom').addEventListener('click', function() {
            svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity.scale(0.8).translate(width / 5, height / 5));
        });
        
        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    }

    // Update accuracy metrics
    function updateAccuracy(accuracy) {
        if (!accuracy) return;

        const precision = accuracy.precision || 0;
        const recall = accuracy.recall || 0;
        const f1 = accuracy.f1 || 0;

        document.getElementById('precision-bar').style.width = `${precision * 100}%`;
        document.getElementById('precision-bar').setAttribute('aria-valuenow', precision * 100);
        document.getElementById('precision-bar').textContent = `${(precision * 100).toFixed(2)}%`;

        document.getElementById('recall-bar').style.width = `${recall * 100}%`;
        document.getElementById('recall-bar').setAttribute('aria-valuenow', recall * 100);
        document.getElementById('recall-bar').textContent = `${(recall * 100).toFixed(2)}%`;

        document.getElementById('f1-bar').style.width = `${f1 * 100}%`;
        document.getElementById('f1-bar').setAttribute('aria-valuenow', f1 * 100);
        document.getElementById('f1-bar').textContent = `${(f1 * 100).toFixed(2)}%`;
    }
});

// Zoom controls for network graph
document.getElementById('zoomIn').addEventListener('click', function() {
    // Will be implemented when D3.js graph is ready
    console.log('Zoom in');
});

document.getElementById('zoomOut').addEventListener('click', function() {
    // Will be implemented when D3.js graph is ready
    console.log('Zoom out');
});

document.getElementById('resetZoom').addEventListener('click', function() {
    // Will be implemented when D3.js graph is ready
    console.log('Reset zoom');
});
</script>
{% endblock %}